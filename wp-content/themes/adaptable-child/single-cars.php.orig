<?php
get_header();
global $imic_options;
<<<<<<< HEAD
if (is_home()) {
    $id = get_option('page_for_posts');
} else {
    $id = get_the_ID();
}
=======

$id = get_option('page_for_posts') ? get_option('page_for_posts') : get_the_ID();
>>>>>>> develop_switching_banners_to_acf

if (is_plugin_active('imithemes-listing/listing.php')) {
    /**
     * Explanation for some of the varibles declared below
     * it needs explaining (it's not very clear from the theme devs)
     * ======================
     * - $post_author_id    - This is the wordpress USER ID attached to this post via whoever created this custom_post type (cars)
     * - $this_user         - this is ID of the custom 'user' post type which is linked to the user_id grabbed from the above
     *
     * ======================
     */
    $pageSidebar2   = get_post_meta(get_the_ID(), 'imic_select_featured_from_list', true);
    $pageSidebar    = get_post_meta(get_the_ID(), 'imic_select_sidebar_from_list', true);
    $sidebar_column = get_post_meta(get_the_ID(), 'imic_sidebar_columns_layout', true);
    if (!empty($pageSidebar) && is_active_sidebar($pageSidebar)) {
        $left_col = 12 - $sidebar_column;
        $class    = $left_col;
    } else {
        $class = 12;
    }
    $list_slugs                  = array();
    $blog_masonry                = 2;
    $post_author_id              = get_post_field('post_author', get_the_ID());
    $this_user                   = get_user_meta($post_author_id, 'imic_user_info_id', true);
    $add                         = get_post_meta($this_user, 'imic_user_zip_code', true);
    $company_name                = get_post_meta($this_user, 'imic_user_company', true);
    $user_thumbid                = get_post_meta($this_user, '_thumbnail_id', true);
    $user_image                  = wp_get_attachment_image_src($user_thumbid, 'thumb', false, array());
    $highlighted_specs           = (isset($imic_options[ 'highlighted_specs' ])) ? $imic_options[ 'highlighted_specs' ] : '';
    $new_highlighted_specs       = imic_filter_lang_specs_admin($highlighted_specs, get_the_ID());
    $highlighted_specs           = $new_highlighted_specs;
    $unique_specs                = $imic_options[ 'unique_specs' ];
    $specifications              = get_post_meta(get_the_ID(), 'feat_data', true);
    $unique_value                = imic_vehicle_price(get_the_ID(), $unique_specs, $specifications);
    $highlight_value             = imic_vehicle_title(get_the_ID(), $highlighted_specs, $specifications);
    $video                       = get_post_meta(get_the_ID(), 'imic_plugin_video_url', true);
    $featured_specifications     = (isset($imic_options[ 'side_specifications' ])) ? $imic_options[ 'side_specifications' ] : array();
    $normal_specifications       = (isset($imic_options[ 'normal_specifications' ])) ? $imic_options[ 'normal_specifications' ] : array();
    $normal_specification        = array();
    $browse_specification_switch = get_post_meta(get_the_ID(), 'imic_browse_by_specification_switch', true);
    $browse_listing              = imic_get_template_url('template-listing.php');
    $download_pdf                = get_post_meta(get_the_ID(), 'imic_plugin_car_manual', true);
    $plan                        = get_post_meta(get_the_ID(), 'imic_plugin_car_plan', true);
    $plan_premium                = get_post_meta($plan, 'imic_pricing_premium_badge', true);
    $userFirstName               = get_the_author_meta('first_name', $post_author_id);
    $userLastName                = get_the_author_meta('last_name', $post_author_id);
    $user_data                   = get_userdata(intval($post_author_id));
    $userName                    = $user_data->display_name;
    if (!empty($userFirstName) || !empty($userLastName)) {
        $userName = $userFirstName . ' ' . $userLastName;
    }

    // $meta = get_post_meta($this_user);
    // var_dump($meta);
    // foreach($meta as $key => $value) {
        // var_dump($key . ': ' . $value);
    // }
    // $bgUrl = wp_get_attachment_url( get_sub_field('image'), 'large-thumbnail' );
    //_thumbnail_id

    $vehicle_status = get_post_meta(get_the_ID(), 'imic_plugin_ad_payment_status', true);
    if ($vehicle_status != 1) {
        echo '<div class="main" role="main">';
            echo '<div id="content" class="content full">';
        	   echo '<div class="container">';
                  echo '<div class="row">';
                      echo '<p>' . __('Vehicle might be sold or not active', 'framework') . '</p>
                  </div>
               </div>
            </div>
            </div>';
        } else {
        $save1                = (isset($_SESSION[ 'saved_vehicle_id1' ])) ? $_SESSION[ 'saved_vehicle_id1' ] : '';
        $save2                = (isset($_SESSION[ 'saved_vehicle_id2' ])) ? $_SESSION[ 'saved_vehicle_id2' ] : '';
        $save3                = (isset($_SESSION[ 'saved_vehicle_id3' ])) ? $_SESSION[ 'saved_vehicle_id3' ] : '';
        $user_id              = get_current_user_id();
        $current_user_info_id = get_user_meta($user_id, 'imic_user_info_id', true);
        if ($current_user_info_id != '') {
            $saved_car_user = get_post_meta($current_user_info_id, 'imic_user_saved_cars', true);
        }
        if ((empty($saved_car_user)) || ($current_user_info_id == '') || ($saved_car_user == '')) {
            $saved_car_user = array(
                $save1,
                $save2,
                $save3
            );
        }
        $save_icon               = (imic_value_search_multi_array(get_the_ID(), $saved_car_user)) ? 'fa-star' : 'fa-star-o';
        $save_icon_disable       = (imic_value_search_multi_array(get_the_ID(), $saved_car_user)) ? 'disabled' : '';
        $enquiry_form1           = (isset($imic_options[ 'enquiry_form1' ])) ? $imic_options[ 'enquiry_form1' ] : '0';
        $editor_form1            = (isset($imic_options[ 'enquiry_form1_editor' ])) ? $imic_options[ 'enquiry_form1_editor' ] : '';
        $enquiry_form2           = (isset($imic_options[ 'enquiry_form2' ])) ? $imic_options[ 'enquiry_form2' ] : '0';
        $editor_form2            = (isset($imic_options[ 'enquiry_form2_editor' ])) ? $imic_options[ 'enquiry_form2_editor' ] : '';
        $enquiry_form3           = (isset($imic_options[ 'enquiry_form3' ])) ? $imic_options[ 'enquiry_form3' ] : '0';
        $editor_form3            = (isset($imic_options[ 'enquiry_form3_editor' ])) ? $imic_options[ 'enquiry_form3_editor' ] : '';
        $classified_data         = get_option('imic_classifieds');
        $classified_data         = (!empty($classified_data)) ? $classified_data : array();
        $listing_details         = (isset($imic_options[ 'listing_details' ])) ? $imic_options[ 'listing_details' ] : 0;
        $specification_data_type = (get_option('imic_specifications_upd_st') != 1) ? 0 : get_option('imic_specifications_upd_st');        ?>

        <?php if ($plan_premium == 1): ?>
            <span class="badge-premium-listing">
                <?php echo esc_attr_e('Premium listing', 'adaptable-child'); ?>
            </span>
        <?php endif; ?>

    <!-- Start Body Content -->
  	<main class="main single-listing" role="main">
    	<div class="container">
            <header class="vehicle-header">
                <div class="row vehicle-header__top">
                    <h2 class="col-md-6 vehicle-header__title"><?php the_title(); ?></h2>
                    <div class="col-md-6 vehicle-header__company-info">
                        <a href="<?php echo esc_url(get_author_posts_url($post_author_id)); ?>">
                            <span class="vehicle-header__company-name"><?php echo esc_attr($company_name); ?></span>
                            <span class="vehicle-header__logo">
                                <?php if (is_array($user_image)): ?>
                                    <img src="<?php echo $user_image[0]; ?>" alt="<?php echo $company_name . ' Company Logo'; ?>" title="<?php echo $company_name; ?>" />
                                <?php else: ?>
                                    <span>Default Logo</span>
                                <?php endif; ?>
                            </span>
                        </a>
                    </div>
                </div>

                <div class="row vehicle-header__bottom">
                    <div class="col-md-4 vehicle-header__price">
                        <h3><?php echo esc_attr($unique_value); ?></h3>
                    </div>
                    <div class="single-listing-actions col-md-7 col-md-offset-1">
                        <div class="pull-right" role="group">
                            <a class="button button--bold button--small button--white" href="#" >Finance</a>
                            <a class="button button--bold button--small button--white" href="#" >Insurance</a>
                            <a class="button button--bold button--small button--white" href="#" >Relocation</a>
                            <?php if ($enquiry_form1 != 2): ?>
                                <a href="#" data-toggle="modal" data-target="#infoModal" class="button button--bold button--small button--black" title="<?php echo esc_attr_e('Request more info', 'adaptable-child'); ?>">
                                    <span><?php echo esc_attr_e('Enquire', 'adaptable-child'); ?></span>
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>

            </header>

            <article class="single-vehicle-details">
                <div class="single-listing-images row">
                    <div class="col-md-12">
                    	<div class="listing-slider">
                            <div id="listing-images" class="flexslider format-gallery">
                                <?php
                                $cars_images = get_post_meta(get_the_ID(), 'imic_plugin_vehicle_images', false);
                                if (empty($cars_images)) {
                                    $attachments = get_attached_media('image', get_the_ID());
                                    if (!empty($attachments)) {
                                        $cars_images = array();
                                        foreach ($attachments as $attachment) {
                                            $cars_images[] = $attachment->ID;
                                        }
                                    }
                                }
                                ?>
                                <ul class="slides">
                                    <?php foreach ($cars_images as $car_image):
                                        $image      = wp_get_attachment_image_src($car_image, '1000x800', '');
                                        $image_full = wp_get_attachment_image_src($car_image, 'full', '');
                                        echo $Lightbox_init = '<li class="media-box"><a href="' . esc_url($image_full[ 0 ]) . '" class="magnific-gallery-image">';
                                        ?>
                                        <img src="<?php echo esc_url($image[0]); ?>" alt=""></a> </li>
                                    <?php endforeach; ?>
                                </ul>
                            </div>
                            <?php if (count($cars_images) > 1): ?>
                                <div class="additional-images">
                                    <div id="listing-thumbs" class="flexslider">
                                        <ul class="slides">
                                            <?php
                                            $start = 1;
                                            foreach ($cars_images as $car_image):
                                                $image      = wp_get_attachment_image_src($car_image, '400x400', '');
                                                $image_full = wp_get_attachment_image_src($car_image, 'full', '');
                                                if ($video != '' && $start == 1) {
                                                    echo $Lightbox_init = '<li class="format-video"><a href="' . esc_url($video) . '" class="magnific-video media-box">';
                                                    echo '<img src="' . esc_url($image[ 0 ]) . '" alt=""></a></li>';
                                                } else { ?>
                                                    <li>
                                                        <a href="<?php echo esc_url($image_full[ 0 ]); ?>" class="media-box"><img src="<?php echo esc_url($image[ 0 ]); ?>" alt=""></a>
                                                    </li>
                                                <?php } ++$start; ?>
                                            <?php endforeach; ?>
                                        </ul>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                  	</div>
                </div>

                <div class="vehicle-single-information row">
                    <div class="col-md-8">
                        <div class="tabs vehicle-single-tabs">
                            <ul class="nav nav-tabs">
                                <?php
                                $count     = 1;
                                $tab_data1 = get_post_meta(get_the_ID(), 'imic_tab_area1', true);
                                $tab_data2 = get_post_meta(get_the_ID(), 'imic_tab_area2', true);
                                $tab_data3 = get_post_meta(get_the_ID(), 'imic_tab_area3', true);
                                $tab_data4 = get_post_meta(get_the_ID(), 'imic_tab_area4', true);
                                $tabs      = (isset($imic_options[ 'details_tab' ])) ? $imic_options[ 'details_tab' ] : array();
                                foreach ($tabs as $tab):
                                    $active_class = ($count == 1) ? 'active' : '';
                                    if (($tab[ 'property_description' ] == '[tab-area1]') && ($tab_data1 != '')) { ?>
                                        <li class="<?php echo esc_attr($active_class); ?>">
                                            <a data-toggle="tab" href="#tab-<?php echo esc_attr($count); ?>"><?php echo esc_attr($tab[ 'title' ]); ?></a>
                                        </li>
                                    <?php } elseif (($tab[ 'property_description' ] == '[tab-area2]') && ($tab_data2 != '')) { ?>
                                        <li class="<?php echo esc_attr($active_class); ?>">
                                            <a data-toggle="tab" href="#tab-<?php echo esc_attr($count); ?>"><?php echo esc_attr($tab[ 'title' ]); ?></a>
                                        </li>
                                    <?php } elseif (($tab[ 'property_description' ] == '[tab-area3]') && ($tab_data3 != '')) { ?>
                                        <li class="<?php echo esc_attr($active_class); ?>">
                                            <a data-toggle="tab" href="#tab-<?php echo esc_attr($count); ?>"><?php echo esc_attr($tab[ 'title' ]); ?></a>
                                        </li>
                                    <?php } elseif (($tab[ 'property_description' ] == '[tab-area4]') && ($tab_data4 != '')) { ?>
                                        <li class="<?php echo esc_attr($active_class); ?>">
                                            <a data-toggle="tab" href="#tab-<?php echo esc_attr($count); ?>"><?php echo esc_attr($tab[ 'title' ]); ?></a>
                                        </li>
                                    <?php } elseif (($tab[ 'property_description' ] != '[tab-area1]') && ($tab[ 'property_description' ] != '[tab-area2]') && ($tab[ 'property_description' ] != '[tab-area3]') && ($tab[ 'property_description' ] != '[tab-area4]')) { ?>
                                        <li class="<?php echo esc_attr($active_class); ?>">
                                            <a data-toggle="tab" href="#tab-<?php echo esc_attr($count); ?>">
                                                <?php echo esc_attr($tab[ 'title' ]); ?>
                                            </a>
                                        </li>
                                    <?php } ++$count; ?>
                                <?php endforeach; ?>
                            </ul>
                            <div class="tab-content">
                                <?php

                                $start = 1;

                                // grab the current vehicle spec instead of doing that in a loop multiple times
                                $this_specification = get_post_meta(get_the_ID(), 'feat_data', true);

                                foreach ($tabs as $tab) {
                                    $active = ($start == 1) ? 'active in' : ''; ?>
                                    <div id="tab-<?php echo esc_attr($start); ?>" class="tab-pane fade <?php echo esc_attr($active); ?>">
                                        <?php
                                        if ($tab[ 'property_description' ] == '[content]') {
                                            if (have_posts()):
                                                while (have_posts()):
                                                    echo '<div class="tab-info">';
                                                        the_post();
                                                        the_content();
                                                    echo '</div>';
                                                endwhile;
                                            endif;
                                        } elseif ($tab[ 'property_description' ] == '[specifications]') {
                                            if (!empty($normal_specifications) && ($listing_details == 0)) {
                                                echo '<table class="table-specifications table table-striped table-hover">';
                                                    echo '<tbody>';

                                                        foreach ($normal_specifications as $normal) {

                                                            $field_type         = get_post_meta($normal, 'imic_plugin_spec_char_type', true);
                                                            $value_labels       = get_post_meta($normal, 'imic_plugin_value_label', true);
                                                            $label_positions    = get_post_meta($normal, 'imic_plugin_lable_position', true);
                                                            $badge_slug         = imic_the_slug($normal);

                                                            if ($field_type == 1) {
                                                                if ($label_positions == 0) {
                                                                    echo '<tr>';
                                                            		    echo '<td>' . get_the_title($normal) . '</td>';
                                                            		    echo '<td>' . $value_labels . get_post_meta($id, 'int_' . $badge_slug, true) . '</td>';
                                                                    echo '</tr>';
                                                                } else {
                                                                    echo '<tr>';
                                                                        echo '<td>' . get_the_title($normal) . '</td>';
                                                                        echo '<td>' . get_post_meta($id, 'int_' . $badge_slug, true) . $value_labels . '</td>';
                                                                    echo '</tr>';
                                                                }
                                                            } else {
                                                                /**
                                                                * The below was checking to see if '$specification_data_type' was 0
                                                                * The theme doesn't make it clear what this is but for any new listing
                                                                * created by users, no data gets pulled through
                                                                *
                                                                * Feels almost like this is here for when you import their dummy data
                                                                * but doing so breaks the theme.
                                                                *
                                                                * In this they are also referencing the completely wrong variable ($featured);
                                                                * ========================
                                                                * if ($specification_data_type == '0') {
                                                                *     $spec_key   = array_search($normal, $this_specification[ 'sch_title' ]);
                                                                *     $second_key = array_search($featured* 111, $this_specification[ 'sch_title' ]);
                                                                * } else {
                                                                * $spec_key = $second_key = '';
                                                                *}
                                                                */

                                                                $spec_key   = array_search($normal, $this_specification[ 'sch_title' ]);
                                                                $second_key = array_search($normal* 111, $this_specification[ 'sch_title' ]);

                                                                if (is_int($spec_key)) {
                                                                    $child_val = '';
                                                                    if (is_int($second_key)) {
                                                                        $child_val = ' ' . $this_specification[ 'start_time' ][ $second_key ];
                                                                    }
                                                                    $value_this = $this_specification[ 'start_time' ][ $spec_key ];
                                                                    if ($value_this != 'select') {
                                                                        if ($label_positions == 0) {
                                                                            echo '<tr>';
                                                                                echo '<td>' . get_the_title($normal) . '</td>';
                                                                                echo '<td>' . $value_labels . $value_this . $child_val . '</td>';
                                                                            echo '</tr>';
                                                                        } else {
                                                                            echo '<tr>
                        	                                                <td>' . get_the_title($normal) . '</td>
                                                                            <td>' . $value_this . $child_val . $value_labels . '</td>
                                                                            </tr>';
                                                                        }
                                                                    }
                                                                } else {
                                                                    $feat_slug_char     = imic_the_slug($normal);
                                                                    $spec_key_val       = get_post_meta(get_the_ID(), 'char_' . $feat_slug_char, true);
                                                                    $spec_key_val_child = get_post_meta(get_the_ID(), 'child_' . $feat_slug_char, true);

                                                                    if ($spec_key_val != 'select') {
                                                                        if ($label_positions == 0) {
                                                                            echo '<tr>';
                                                                                echo '<td>' . get_the_title($normal) . '</td>';
                                                                                echo '<td>' . $value_labels . $spec_key_val . '</td>';
                                                                            echo '</tr>';

                                                                            if ($spec_key_val_child != '') {
                                                                                $child_label = get_post_meta($normal, 'imic_plugin_sub_field_label', true);
                                                                                echo '<tr>';
                                                                                    echo '<td>' . $child_label . '</td>';
                                                                                    echo '<td>' . $spec_key_val_child . '</td>';
                                                                                echo '</tr>';
                                                                            }
                                                                        } else {
                                                                            echo '<tr>';
                        	                                                   echo '<td>' . get_the_title($normal) . '</td>';
                                                                               echo '<td>' . $spec_key_val . $value_labels . '</td>';
                       		                                                echo '</tr>';
                                                                            if ($spec_key_val_child != '') {
                                                                                $child_label = get_post_meta($normal, 'imic_plugin_sub_field_label', true);
                                                                                echo '<tr>';
                                                                                    echo '<td>' . $child_label . '</td>';
                                                                                    echo '<td>' . $spec_key_val_child . '</td>';
                                                                                echo '</tr>';
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    echo '</tbody>';
                                                echo '</table>';
                                            } else {
                                                echo '<table class="table-specifications table table-striped table-hover">
                                                    <tbody>';
                                                        if (!empty($normal_specification)) {
                                                            foreach ($normal_specification as $normal) {
                                                                $field_type         = get_post_meta($normal, 'imic_plugin_spec_char_type', true);
                                                                $value_labels       = get_post_meta($normal, 'imic_plugin_value_label', true);
                                                                $label_positions    = get_post_meta($normal, 'imic_plugin_lable_position', true);
                                                                $badge_slug         = imic_the_slug($normal);
                                                                $this_specification = get_post_meta(get_the_ID(), 'feat_data', true);
                                                                if ($field_type == 1) {
                                                                    if ($label_positions == 0) {
                                                                        echo '<tr>';
                                                            	              echo '<td>' . get_the_title($normal) . '</td>';
                                                            	              echo '<td>' . $value_labels . get_post_meta($id, 'int_' . $badge_slug, true) . '</td>';
                                                                        echo '</tr>';
                                                                    } else {
                                                                        echo '<tr>';
                                                                            echo '<td>' . get_the_title($normal) . '</td>';
                                                                            echo '<td>' . get_post_meta($id, 'int_' . $badge_slug, true) . $value_labels . '</td>';
                                                                        echo '</tr>';
                                                                    }
                                                                } else {
                                                                    if ($specification_data_type == '0') {
                                                                        $spec_key = array_search($normal, $this_specification[ 'sch_title' ]);
                                                                    } else {
                                                                        $spec_key = '';
                                                                    }
                                                                    if (is_int($spec_key)) {
                                                                        $value_this = $this_specification[ 'start_time' ][ $spec_key ];
                                                                        if ($value_this != 'select') {
                                                                            if ($label_positions == 0) {
                                                                                echo '<tr>';
                                                                                    echo '<td>' . get_the_title($normal) . '</td>';
                                                                                    echo '<td>' . $value_labels . $value_this . '</td>';
                                                                                echo '</tr>';
                                                                            } else {
                                                                                echo '<tr>';
                                                                                    echo '<td>' . get_the_title($normal) . '</td>';
                                                            		                echo '<td>' . $value_this . $value_labels . '</td>';
                                                                                echo '</tr>';
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    echo '</tbody>';
                                                echo '</table>';
                                            }
                                        } elseif ($tab[ 'property_description' ] == '[features]') {
                                            echo '<div class="tab-info">';
                                                echo '<ul class="add-features-list">';
                                                    $features = get_the_terms(get_the_ID(), 'cars-tag');
                                                    if (!empty($features)) {
                                                        $new_features = imic_filter_lang_specs($features);
                                                        foreach ($new_features as $feature) {
                                                            echo '<li>' . $feature->name . '</li>';
                                                        }
                                                    }
                                                echo '</ul>';
                                            echo '</div>';
                                        } elseif ($tab[ 'property_description' ] == '[location]') {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode('[gmap address="' . $add . '"]');
                                            echo '</div>';
                                        } elseif (($tab[ 'property_description' ] == '[tab-area1]') && ($tab_data1 != '')) {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode($tab_data1);
                                            echo '</div>';
                                        } elseif (($tab[ 'property_description' ] == '[tab-area2]') && ($tab_data2 != '')) {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode($tab_data2);
                                            echo '</div>';
                                        } elseif (($tab[ 'property_description' ] == '[tab-area3]') && ($tab_data3 != '')) {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode($tab_data3);
                                            echo '</div>';
                                        } elseif (($tab[ 'property_description' ] == '[tab-area4]') && ($tab_data4 != '')) {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode($tab_data4);
                                            echo '</div>';
                                        } else {
                                            echo '<div class="tab-info">';
                                                echo do_shortcode($tab[ 'property_description' ]);
                                            echo '</div>';
                                        }
                                    echo '</div>';
                                    ++$start;
                                } ?>
                            </div>
                        </div>

                        <div class="listingShare">
                            <a <?php echo esc_attr($save_icon_disable); ?> href="#" rel="popup-save" class="button button--small button--passive save-car" title="<?php echo esc_attr_e('Save this listing', 'adaptable-child'); ?>">
                                <span><?php echo esc_attr_e('Save this listing', 'adaptable-child'); ?></span>
                                <div class="vehicle-details-access" style="display:none;">
                                    <span class="vehicle-id"><?php echo esc_attr(get_the_ID()); ?></span>
                                </div>
                            </a>
                            <a href="#" data-toggle="modal" data-target="#sendModal" class="button button--small button--passive" title="<?php echo esc_attr_e('Send To A Friend','adaptable-child'); ?>">
                                <span><?php echo esc_attr_e('Send To A Friend','adaptable-child'); ?></span>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 sidebar-widget widget">
                        <?php if ((!empty($featured_specifications)) && ($listing_details == 0)) { ?>
                            <div class="specification-sidebar">
                                <h6 class="specification-sidebar__title">Specification</h6>
                                <ul class="specification-sidebar__list list-group">
                                    <?php
                                    $this_specification = get_post_meta(get_the_ID(), 'feat_data', true);
                                    foreach ($featured_specifications as $featured) {

                                        $field_type         = get_post_meta($featured, 'imic_plugin_spec_char_type', true);
                                        $value_label        = get_post_meta($featured, 'imic_plugin_value_label', true);
                                        $label_position     = get_post_meta($featured, 'imic_plugin_lable_position', true);
                                        $badge_slug         = imic_the_slug($featured);

                                        /**
                                         * The below was checking to see if '$specification_data_type' was 0
                                         * The theme doesn't make it clear what this is but for any new listing
                                         * created by users, no data gets pulled through
                                         *
                                         * Feels almost like this is here for when you import their dummy data
                                         * but doing so breaks the theme.
                                         * ========================
                                         * if ($specification_data_type == '0') {
                                         * 		$spec_key   = array_search($featured, $this_specification[ 'sch_title' ]);
                                         *  	$second_key = array_search($featured * 111, $this_specification[ 'sch_title' ]);
                                         * } else {
                                         * $spec_key = $second_key = '';
                                         * }
                                         */

                                        // Updated for new listings
                                        $spec_key   = array_search($featured, $this_specification[ 'sch_title' ]);
                                        $second_key = array_search($featured * 111, $this_specification[ 'sch_title' ]);

                                        $feat_val = get_post_meta($id, 'int_' . $badge_slug, true);

                                        if ($field_type == 1 && $feat_val != '') {
                                            if ($label_position == 0) {
                                                echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $value_label . $feat_val . '</li>';
                                            } else {
                                                echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . get_post_meta($id, 'int_' . $badge_slug, true) . $value_label . '</li>';
                                            }
                                        } else {
                                            if (is_int($spec_key)) {
                                                $child_val = '';
                                                if (is_int($second_key)) {
                                                    $child_val = ' ' . $this_specification[ 'start_time' ][ $second_key ];
                                                }
                                                $spec_feat_val = $this_specification[ 'start_time' ][ $spec_key ];
                                                if ($spec_feat_val != '') {
                                                    if ($label_position == 0) {
                                                        echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $value_label . $this_specification[ 'start_time' ][ $spec_key ] . $child_val . '</li>';
                                                    } else {
                                                        echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $this_specification[ 'start_time' ][ $spec_key ] . $child_val . $value_label . '</li>';
                                                    }
                                                }
                                            } else {
                                                $spec_slug           = imic_the_slug($featured);
                                                $spec_val_char       = get_post_meta(get_the_ID(), 'char_' . $spec_slug, true);
                                                $spec_val_char_child = get_post_meta(get_the_ID(), 'child_' . $spec_slug, true);
                                                if ($spec_val_char != '' && $spec_val_char != 'Select') {
                                                    if ($label_position == 0) {
                                                        echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $value_label . $spec_val_char . ' ' . $spec_val_char_child . '</li>';
                                                    } else {
                                                        echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $spec_val_char . ' ' . $spec_val_char_child . $value_label . '</li>';
                                                    }
                                                }
                                            }
                                        }
                                    } ?>
                                </ul>
                            </div>
                        <?php } else {
                            $args_terms   = array(
                                'orderby' => 'name',
                                'order' => 'ASC',
                                'fields' => 'all'
                            );
                            $this_terms   = wp_get_post_terms(get_the_ID(), 'listing-category', $args_terms);
                            $get_val_term = '';
                            foreach ($this_terms as $term) {
                                $list_slugs[] = $term->slug;
                                if (array_key_exists($term->term_id, $classified_data)) {
                                    if ($classified_data[ $term->term_id ][ 'featured' ] != '') {
                                        $get_val_term = $term->term_id;
                                        break;
                                    }
                                }
                            }
                            if (!empty($get_val_term)) {
                                $featured_specifications = $classified_data[ $get_val_term ][ 'featured' ];
                                $featured_specifications = explode(',', $featured_specifications);
                                $normal_specification    = $classified_data[ $get_val_term ][ 'detailed' ];
                                $normal_specification    = explode(',', $normal_specification);
                                ?>
                                <div class="specification-sidebar">
                                    <h6 class="specification-sidebar__title">Specification</h6>
                                    <ul class="specification-sidebar__list list-group">
                                        <?php
                                        foreach ($featured_specifications as $featured) {
                                            $field_type         = get_post_meta($featured, 'imic_plugin_spec_char_type', true);
                                            $value_label        = get_post_meta($featured, 'imic_plugin_value_label', true);
                                            $label_position     = get_post_meta($featured, 'imic_plugin_lable_position', true);
                                            $badge_slug         = imic_the_slug($featured);
                                            $this_specification = get_post_meta(get_the_ID(), 'feat_data', true);
                                            if ($specification_data_type == '0') {
                                                $spec_key   = array_search($featured, $this_specification[ 'sch_title' ]);
                                                $second_key = array_search($featured * 111, $this_specification[ 'sch_title' ]);
                                            } else {
                                                $spec_key = $second_key = '';
                                            }
                                            $feat_val = get_post_meta($id, 'int_' . $badge_slug, true);
                                            if ($field_type == 1 && $feat_val != '') {
                                                if ($label_position == 0) {
                                                    echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $value_label . get_post_meta($id, 'int_' . $badge_slug, true) . '</li>';
                                                } else {
                                                    echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . get_post_meta($id, 'int_' . $badge_slug, true) . $value_label . '</li>';
                                                }
                                            } else {
                                                if (is_int($spec_key)) {
                                                    $child_val = '';
                                                    if (is_int($second_key)) {
                                                        $child_val = ' ' . $this_specification[ 'start_time' ][ $second_key ];
                                                    }
                                                    $spec_feat_val = $this_specification[ 'start_time' ][ $spec_key ];
                                                    if ($spec_feat_val != '') {
                                                        if ($label_position == 0) {
                                                            echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $value_label . $this_specification[ 'start_time' ][ $spec_key ] . $child_val . '</li>';
                                                        } else {
                                                            echo '<li class="list-group-item"> <span class="badge">' . get_the_title($featured) . '</span> ' . $this_specification[ 'start_time' ][ $spec_key ] . $child_val . $value_label . '</li>';
                                                        }
                                                    }
                                                }
                                            }
                                        } ?>
                                    </ul>
                                </div>
                            <?php }
                        }
                        ?>
                        <div class="custom-sidebar">
                            <?php dynamic_sidebar($pageSidebar2); ?>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </main>
    <!-- End Body Content -->

    <!-- related listings -->
    <?php get_template_part('includes/theme/adp-single_listing', 'related_listings'); ?>
    <!-- related listings -->

    <!-- SEND TO FRIEND -->
    <div class="modal fade" id="sendModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?php echo esc_attr_e('Send To A Friend', 'adaptable-child'); ?></h4>
                </div>

                <div class="modal-body">
                    <p><?php echo esc_attr_e('Want to send this to a friend? We\'ve got you covered, just fill the form out below and we\'ll handle the rest!', 'adaptable-child'); ?></p>
                    <form class="enquiry-vehicle">
                        <input type="hidden" name="email_content" value="enquiry_form">
                        <input type="hidden" name="Subject" id="subject" value="Send To A Friend">
                        <input type="hidden" name="Vehicle_ID" value="<?php echo esc_attr(get_the_ID()); ?>">

                        <div class="row">
                            <div class="col-sm-12">
                                <div class="input-group">
                                    <input type="text" name="Name" class="form-control" placeholder="<?php echo esc_attr_e('Your Name', 'adaptable-child'); ?>">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="email" name="Email" class="form-control" placeholder="<?php echo esc_attr_e('Your Email', 'adaptable-child'); ?>">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" name="Friendemail" class="form-control" placeholder="<?php echo esc_attr_e('Friends Email', 'adaptable-child'); ?>">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="message"></div>
                        </div>

                        <input type="submit" class="btn btn-primary pull-right" value="<?php echo esc_attr_e('Submit', 'adaptable-child'); ?>">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- REQUEST MORE INFO POPUP -->
    <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?php echo esc_attr_e('Request more info', 'adaptable-child'); ?></h4>
                </div>
                <div class="modal-body">
                    <?php if ($enquiry_form1 == 0) { ?>
                        <p><?php echo esc_attr_e('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla convallis egestas rhoncus. Donec facilisis fermentum sem, ac viverra ante luctus vel. Donec vel mauris quam.', 'adaptable-child'); ?></p>
                        <form class="enquiry-vehicle">
                            <input type="hidden" name="email_content" value="enquiry_form">
	                        <input type="hidden" name="Subject" id="subject" value="Request More Info">
                            <input type="hidden" name="Vehicle_ID" value="<?php echo esc_attr(get_the_ID()); ?>">

                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-user"></i></span>
                                <input type="text" name="Name" class="form-control" placeholder="<?php echo esc_attr_e('Full Name', 'adaptable-child'); ?>">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-envelope"></i></span>
                                        <input type="email" name="Email" class="form-control" placeholder="<?php echo esc_attr_e('Email', 'adaptable-child'); ?>">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-phone"></i></span>
                                        <input type="text" name="Phone" class="form-control" placeholder="<?php echo esc_attr_e('Phone', 'adaptable-child');   ?>">
                                    </div>
                                </div>
                            </div>

                            <input type="submit" class="btn btn-primary pull-right" value="<?php echo esc_attr_e('Request Info', 'adaptable-child'); ?>">
                            <label class="btn-block"><?php echo esc_attr_e('Preferred Contact', 'adaptable-child'); ?></label>
                            <label class="checkbox-inline"><input name="Preferred Contact Email" value="yes" type="checkbox"> <?php echo esc_attr_e('Email', 'adaptable-child'); ?></label>
                            <label class="checkbox-inline"><input name="Preferred Contact Phone" value="yes" type="checkbox"> <?php echo esc_attr_e('Phone', 'adaptable-child'); ?></label>

                            <div class="message"></div>
                        </form><?php
                    } elseif ($enquiry_form1 == 1) {
                        echo do_shortcode($editor_form1);
                    } ?>
                </div>
            </div>
        </div>
    </div>

    <!-- BOOK TEST DRIVE POPUP -->
    <div class="modal fade" id="testdriveModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?php echo esc_attr_e('Book a test drive', 'adaptable-child'); ?></h4>
                </div>

                <div class="modal-body">
                    <?php if ($enquiry_form2 == 0) { ?>
                        <p><?php echo esc_attr_e('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla convallis egestas rhoncus. Donec facilisis fermentum sem, ac viverra ante luctus vel. Donec vel mauris quam.', 'adaptable-child'); ?></p>
                        <form class="enquiry-vehicle">
                            <input type="hidden" name="email_content" value="enquiry_form">
                            <input type="hidden" name="Subject" id="subject" value="Book a test drive">
                            <input type="hidden" name="Vehicle_ID" value="<?php echo esc_attr(get_the_ID()); ?>">

                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-user"></i></span>
                                <input type="text" name="Name" class="form-control" placeholder="<?php echo esc_attr_e('Full Name', 'adaptable-child'); ?>">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-envelope"></i></span>
                                        <input type="email" name="Email" class="form-control" placeholder="<?php echo esc_attr_e('Email', 'adaptable-child'); ?>">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-phone"></i></span>
                                        <input type="text" name="Phone" class="form-control" placeholder="<?php echo esc_attr_e('Phone', 'adaptable-child'); ?>">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                        <input type="text" name="Preferred Date" id="datepicker" class="form-control" placeholder="<?php echo esc_attr_e('Preferred Date', 'adaptable-child'); ?>">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-append bootstrap-timepicker">
                                        <span class="input-group-addon add-on"><i class="fa fa-clock-o"></i></span>
                                        <input type="text" name="Preferred Time" id="timepicker" class="form-control" placeholder="<?php echo esc_attr_e('Preferred time', 'adaptable-child'); ?>">
                                    </div>
                                </div>
                            </div>

                            <input type="submit" class="btn btn-primary pull-right" value="<?php echo esc_attr_e('Schedule Now', 'adaptable-child'); ?>">
                            <label class="btn-block"><?php echo esc_attr_e('Preferred Contact', 'adaptable-child'); ?></label>
                            <label class="checkbox-inline"><input name="Preferred Contact Email" value="yes" type="checkbox"> <?php echo esc_attr_e('Email', 'adaptable-child');  ?></label>
                            <label class="checkbox-inline"><input name="Preferred Contact Phone" value="yes" type="checkbox"> <?php echo esc_attr_e('Phone', 'adaptable-child'); ?></label>

                            <div class="message"></div>
                        </form><?php
                    } elseif ($enquiry_form2 == 1) {
                        echo do_shortcode($editor_form2);
                    } ?>
                </div>
            </div>
        </div>
    </div>

    <!-- MAKE AN OFFER POPUP -->
    <div class="modal fade" id="offerModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?php echo esc_attr_e('Make an offer', 'adaptable-child'); ?></h4>
                </div>
                <div class="modal-body">
                    <?php if ($enquiry_form3 == 0) { ?>
                        <p><?php echo esc_attr_e('Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla convallis egestas rhoncus. Donec facilisis fermentum sem, ac viverra ante luctus vel. Donec vel mauris quam.', 'adaptable-child'); ?></p>

                        <form class="enquiry-vehicle">
                            <input type="hidden" name="email_content" value="enquiry_form">
                            <input type="hidden" name="Subject" id="subject" value="<?php echo esc_attr_e('Make an offer', 'adaptable-child'); ?>">
                            <input type="hidden" name="Vehicle_ID" value="<?php echo esc_attr(get_the_ID()); ?>">

                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-user"></i></span>
                                <input type="text" name="Name" class="form-control" placeholder="<?php echo esc_attr_e('Full Name', 'adaptable-child'); ?>">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-envelope"></i></span>
                                        <input type="email" name="Email" class="form-control" placeholder="<?php echo esc_attr_e('Email', 'adaptable-child'); ?>">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-phone"></i></span>
                                        <input type="text" name="Phone" class="form-control" placeholder="<?php echo esc_attr_e('Phone', 'adaptable-child'); ?>">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-dollar"></i></span>
                                        <input type="text" name="Offered Price" class="form-control" placeholder="<?php echo esc_attr_e('Offered Price', 'adaptable-child');  ?>">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><i class="fa fa-credit-card"></i></span>
                                        <select name="Financing Required" type="text" class="form-control selectpicker">
                                            <option value="no" selected><?php echo esc_attr_e('Financing required?', 'adaptable-child'); ?></option>
                                            <option value="yes"><?php echo esc_attr_e('Yes', 'adaptable-child'); ?></option>
                                            <option value="no"><?php echo esc_attr_e('No', 'adaptable-child'); ?></option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <textarea class="form-control" name="Additional Comments" placeholder="<?php echo esc_attr_e('Additional comments', 'adaptable-child'); ?>"></textarea>
                            <input type="submit" class="btn btn-primary pull-right" value="<?php echo esc_attr_e('Submit', 'adaptable-child'); ?>">
                            <div class="clearfix"></div>
                            <div class="message"></div>
                        </form><?php
                    } elseif ($enquiry_form3 == 1) {
                        echo do_shortcode($editor_form3);
                    }   ?>
                </div>
            </div>
        </div>
    </div>

    <?php //Session for recently viewed cars
        if (!isset($_SESSION[ 'viewed_vehicle_id1' ])) {
            $_SESSION[ 'viewed_vehicle_id1' ] = get_the_ID  ();
        } elseif (!isset($_SESSION[ 'viewed_vehicle_id2' ])) {
            if ($_SESSION[ 'viewed_vehicle_id1' ] != get_the_ID()) {
                $_SESSION[ 'viewed_vehicle_id2' ] = get_the_ID();
            }
        } elseif (!isset($_SESSION[ 'viewed_vehicle_id3' ])) {
            if ($_SESSION[ 'viewed_vehicle_id1' ] != get_the_ID() && $_SESSION[ 'viewed_vehicle_id2' ] != get_the_ID()) {
                $_SESSION[ 'viewed_vehicle_id3' ] = get_the_ID();
            }
        } else {
            unset($_SESSION[ 'viewed_vehicle_id1' ]);
            if ($_SESSION[ 'viewed_vehicle_id2' ] != get_the_ID() && $_SESSION[ 'viewed_vehicle_id3' ] != get_the_ID()) {
                $_SESSION[ 'viewed_vehicle_id1' ] = get_the_ID();
            }
        }
    } //End of status view

} else {
?>
    <div class="main" role="main">
        <div id="content" class="content full">
            <div class="container">
                <div class="text-align-center error-404">
                    <h1 class="huge"><?php echo esc_attr_e('Sorry', 'adaptable-child'); ?></h1>
                    <hr class="sm">
                    <p>
                        <strong><?php echo esc_attr_e('Sorry - Plugin not active', 'adaptable-child'); ?></strong>
                    </p>
                    <p><?php echo esc_attr_e('Please install and activate required plugins of theme.', 'adaptable-child'); ?></p>
                </div>
            </div>
        </div>
    </div>
<?php }

if (is_plugin_active('imi-classifieds/imi-classified.php')) {
    imic_viewed_listing(get_the_ID());
}
get_footer(); ?>
